name: PHPStan Auto-Fix (Simple)

on:
  workflow_run:
    workflows: ["PHPStan"]
    types:
      - completed
  push:
    branches: [main, develop, feat/*]
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-fix-phpstan:
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'push' || github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"

      - name: Cache composer dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}

      - name: Install dependencies
        run: composer install -n --prefer-dist

      - name: Check if PHPStan has errors
        id: check-phpstan-errors
        run: |
          if ./vendor/bin/phpstan analyse --memory-limit=512M --no-progress > /dev/null 2>&1; then
            echo "has_errors=false" >> $GITHUB_OUTPUT
            echo "No PHPStan errors found"
          else
            echo "has_errors=true" >> $GITHUB_OUTPUT
            echo "PHPStan errors found"
          fi

      - name: Run PHPStan to get detailed errors
        id: phpstan-details
        run: |
          echo "errors=$(./vendor/bin/phpstan analyse --memory-limit=512M --error-format=json 2>/dev/null || echo '[]')" >> $GITHUB_OUTPUT
          echo "error_count=$(echo '${{ steps.phpstan-details.outputs.errors }}' | jq length 2>/dev/null || echo '0')" >> $GITHUB_OUTPUT

      - name: Create fix branch
        if: steps.check-phpstan-errors.outputs.has_errors == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b fix/phpstan-issues-${{ github.run_number }}

      - name: Apply Rector and PHPStan fixes
        if: steps.check-phpstan-errors.outputs.has_errors == 'true'
        run: |
          echo "Applying Rector and PHPStan fixes..."
          
          # Step 1: Run Rector (more sophisticated fixes)
          echo "Running Rector..."
          ./vendor/bin/rector process --no-progress-bar || echo "Rector completed with some issues"
          
          # Step 2: Run custom PHPStan fixes for remaining issues
          echo "Running custom PHPStan fixes..."
          chmod +x .github/scripts/fix-phpstan-issues.php
          php .github/scripts/fix-phpstan-issues.php --verbose || echo "Custom fixes completed"
          
          # Step 3: Apply basic fixes as fallback
          echo "Applying basic fixes as fallback..."
          
          # Fix 1: Add missing return types for void functions
          find src -name "*.php" -exec sed -i 's/function \([a-zA-Z_][a-zA-Z0-9_]*\)(/function \1(): void(/g' {} \;
          
          # Fix 2: Add mixed type hints for properties
          find src -name "*.php" -exec sed -i 's/private \$\([a-zA-Z_][a-zA-Z0-9_]*\);/private \$\1: mixed;/g' {} \;
          find src -name "*.php" -exec sed -i 's/protected \$\([a-zA-Z_][a-zA-Z0-9_]*\);/protected \$\1: mixed;/g' {} \;
          find src -name "*.php" -exec sed -i 's/public \$\([a-zA-Z_][a-zA-Z0-9_]*\);/public \$\1: mixed;/g' {} \;
          
          # Fix 3: Add array type hints
          find src -name "*.php" -exec sed -i 's/array</array<int, mixed></g' {} \;
          
          echo "Applied all fixes"

      - name: Check if fixes were applied
        if: steps.check-phpstan-errors.outputs.has_errors == 'true'
        id: check-fixes
        run: |
          if git diff --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "No changes were made"
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "Changes were made"
            git diff --stat
          fi

      - name: Commit fixes
        if: steps.check-phpstan-errors.outputs.has_errors == 'true' && steps.check-fixes.outputs.no_changes == 'false'
        run: |
          git add .
          git commit -m "fix: automatically fix PHPStan issues with Rector

          - Applied Rector refactoring rules
          - Added missing return types
          - Added type hints for properties
          - Fixed array type declarations
          - Applied code quality improvements

          Auto-generated by GitHub Actions workflow."

      - name: Push changes
        if: steps.check-phpstan-errors.outputs.has_errors == 'true' && steps.check-fixes.outputs.no_changes == 'false'
        run: |
          git push origin fix/phpstan-issues-${{ github.run_number }}

      - name: Create Pull Request
        if: steps.check-phpstan-errors.outputs.has_errors == 'true' && steps.check-fixes.outputs.no_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”§ Auto-fix PHPStan Issues',
              head: 'fix/phpstan-issues-${{ github.run_number }}',
              base: '${{ github.event.workflow_run.head_branch || github.ref_name }}',
              body: `## ðŸ”§ Automatically Fixed PHPStan Issues

              This PR was automatically created to fix PHPStan static analysis issues detected in the CI pipeline.

              ### What was fixed:
              - âœ… Added missing return types
              - âœ… Added type hints for class properties  
              - âœ… Added basic docblock annotations
              - âœ… Fixed array type declarations

              ### How it works:
              This PR was created by the [PHPStan Auto-Fix workflow](.github/workflows/phpstan-auto-fix-simple.yml) which:
              1. Detects when the PHPStan workflow fails
              2. Applies common fixes for typical issues
              3. Creates a PR with the fixes

              ### Review:
              Please review the changes and merge if they look correct. The fixes are based on common patterns and may need manual adjustment.

              ---
              *This PR was created automatically by GitHub Actions.*`
            });

            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['bug', 'phpstan', 'auto-generated']
            });

            // Assign to the repository owner
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              assignees: ['baspa']
            });

            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

      - name: Comment on original workflow run
        if: steps.check-phpstan-errors.outputs.has_errors == 'true' && steps.check-fixes.outputs.no_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.workflow_run.pull_requests[0].number || 'null' }}
            });

            const hasExistingComment = comments.some(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ðŸ”§ Auto-fix PHPStan Issues')
            );

            if (!hasExistingComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.workflow_run.pull_requests[0].number || 'null' }},
                body: `## ðŸ”§ PHPStan Issues Auto-Fixed

                The PHPStan workflow detected issues and I've automatically created a fix PR for you!

                **Fix PR:** [ðŸ”§ Auto-fix PHPStan Issues](https://github.com/${{ github.repository }}/pull/{{ pr_number }})

                The automated fix script has addressed common PHPStan issues. Please review and merge the fix PR when ready.

                ---
                *This comment was created automatically by the PHPStan Auto-Fix workflow.*`
              });
            }
